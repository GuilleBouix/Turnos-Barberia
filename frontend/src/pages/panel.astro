---
import Layout from '../layouts/Layout.astro';
import TabTurnos from '../components/Panel/TabTurnos.astro';
import TabNegocio from '../components/Panel/TabNegocio.astro';
import TabServicios from '../components/Panel/TabServicios.astro';
---

<Layout>
    <div class="text-white">
        <!-- Cabecera -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold font-playfair">PANEL DE CONTROL</h1>
            <button id="logoutBtn" class="border border-white px-4 py-2 font-light text-[16px] text-white cursor-pointer
              hover:bg-white hover:text-black transition-colors duration-200">
                Cerrar Sesión
            </button>
        </div>
        
        <!-- Datos de usuario -->
        <div id="userInfo" class="bg-[#101010] mb-6 p-4 border border-[#3d3d3d]">
            Cargando datos...
        </div>
        
        <!-- Botones de configuración -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <button id="tab-turnos" class="tab-button bg-[#101010] border border-[#3d3d3d] text-left p-4 cursor-pointer duration-200 hover:bg-white hover:border-white hover:text-black">
                <h3 class="text-lg font-semibold">Turnos</h3>
                <p class="text-[#8f8f8f]">Gestionar turnos</p>
            </button>
            
            <button id="tab-negocio" class="tab-button bg-[#101010] border border-[#3d3d3d] text-left p-4 cursor-pointer duration-200 hover:bg-white hover:border-white hover:text-black">
                <h3 class="text-lg font-semibold">Negocio</h3>
                <p class="text-[#8f8f8f]">Configurar negocio</p>
            </button>
            
            <button id="tab-servicios" class="tab-button bg-[#101010] border border-[#3d3d3d] text-left p-4 cursor-pointer duration-200 hover:bg-white hover:border-white hover:text-black">
                <h3 class="text-lg font-semibold">Servicios</h3>
                <p class="text-[#8f8f8f]">Gestionar servicios</p>
            </button>
        </div>

        <!------------ Contenido de las Tabs ------------>
        <TabTurnos />
        <TabNegocio />
        <TabServicios />
    </div>

    <!-- Script para manejar autenticación y mostrar datos del usuario -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('jwtToken');
            const userInfoDiv = document.getElementById('userInfo');
            
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inválido');
                }

                const data = await response.json();
                
                // Mostrar información del usuario
                userInfoDiv.innerHTML = ''; // Limpiar
                const welcome = document.createElement('h3');
                welcome.className = 'text-xl font-bold';
                welcome.textContent = `Bienvenido, ${data.usuario.nombre_usuario}`;
                
                const id = document.createElement('p');
                id.className = 'text-[#8f8f8f] text-sm';
                id.textContent = ``;
                
                const created = document.createElement('p');
                created.className = 'text-[#8f8f8f]';
                created.textContent = `Miembro desde: ${new Date(data.usuario.creado_en).toLocaleDateString()}`;
                
                userInfoDiv.appendChild(welcome);
                userInfoDiv.appendChild(id);
                userInfoDiv.appendChild(created);
                
            } catch (error) {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userData');
                window.location.href = '/login';
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('userData');
                    window.location.href = '/login';
                });
            }
        });
    </script>

    <!-- Script para alternar tabs -->
    <script type="text/javascript">
        // Si presiono el boton con id="tab-turnos", muestro el div con id="content-turnos" eliminando la clase hidden
        document.getElementById('tab-turnos').addEventListener('click', function() {
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.add('hidden');
            });
            document.getElementById('content-turnos').classList.remove('hidden');
        });

        document.getElementById('tab-negocio').addEventListener('click', function() {
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.add('hidden');
            });
            document.getElementById('content-negocio').classList.remove('hidden');
        });

        document.getElementById('tab-servicios').addEventListener('click', function() {
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.add('hidden');
            });
            document.getElementById('content-servicios').classList.remove('hidden');
        });
    </script>
</Layout>
<div id="content-negocio" class="tab-content hidden p-6 bg-[#101010] border border-[#3d3d3d]">
    <!-- Encabezado -->
    <div class="border-b border-[#3d3d3d] pb-4 mb-6">
        <h4 class="text-2xl font-bold mb-1">Configurar Negocio</h4>
        <p class="text-[#8f8f8f] text-sm">Gestiona la informaci√≥n general y horarios de tu barber√≠a</p>
    </div>

    <!-- Mensaje de estado -->
    <div id="messageDiv" class="hidden mb-4 p-4 "></div>

    <!-- Contenedor principal -->
    <div class="space-y-8">
        
        <!-- SECCI√ìN 1: Informaci√≥n General del Negocio -->
        <div class="bg-[#101010] border border-[#3d3d3d] p-6">
            <h5 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Informaci√≥n General
            </h5>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Nombre del negocio -->
                <div>
                    <label class="block text-[#8f8f8f] text-sm mb-2">Nombre del Negocio</label>
                    <input 
                        type="text" 
                        id="nombre-negocio"
                        placeholder="Ej: Barber√≠a Premium"
                        class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white placeholder-[#555] focus:border-white transition"
                    />
                </div>

                <!-- Tel√©fono -->
                <div>
                    <label class="block text-[#8f8f8f] text-sm mb-2">Tel√©fono</label>
                    <input 
                        type="tel" 
                        id="telefono-negocio"
                        placeholder="Ej: +54 9 376 123 4567"
                        class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white placeholder-[#555] focus:border-white transition"
                    />
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-[#8f8f8f] text-sm mb-2">Email</label>
                    <input 
                        type="email" 
                        id="email-negocio"
                        placeholder="Ej: info@barberia.com"
                        class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white placeholder-[#555] focus:border-white transition"
                    />
                </div>

                <!-- Direcci√≥n -->
                <div>
                    <label class="block text-[#8f8f8f] text-sm mb-2">Direcci√≥n</label>
                    <input 
                        type="text" 
                        id="direccion-negocio"
                        placeholder="Ej: Calle Principal 123"
                        class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white placeholder-[#555] focus:border-white transition"
                    />
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: Horarios por D√≠a -->
        <div class="bg-[#101010] border border-[#3d3d3d] p-6 max-md:p-4">
            <h5 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Horarios de Atenci√≥n
            </h5>
            
            <!-- Contenedor de d√≠as -->
            <div id="diasContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Se llena din√°micamente con JS -->
            </div>
        </div>

        <!-- SECCI√ìN 3: Configuraci√≥n Adicional -->
        <div class="bg-[#101010] border border-[#3d3d3d] p-6 ">
            <h5 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Configuraci√≥n Adicional
            </h5>
            
            <div class="space-y-4">
                <!-- Duraci√≥n por defecto de turnos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[#8f8f8f] text-sm mb-2">Duraci√≥n Promedio por Turno (minutos)</label>
                        <select 
                            id="duracion-turno"
                            class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white focus:border-white transition"
                        >
                            <option value="30">30 minutos</option>
                            <option value="45">45 minutos</option>
                            <option value="60">60 minutos</option>
                            <option value="90">90 minutos</option>
                        </select>
                    </div>

                    <!-- Intervalo entre turnos -->
                    <div>
                        <label class="block text-[#8f8f8f] text-sm mb-2">Intervalo entre Turnos (minutos)</label>
                        <select 
                            id="intervalo-turnos"
                            class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white focus:border-white transition"
                        >
                            <option value="15">15 minutos</option>
                            <option value="30">30 minutos</option>
                            <option value="45">45 minutos</option>
                            <option value="60">60 minutos</option>
                        </select>
                    </div>
                </div>

                <!-- M√°ximo turnos por d√≠a -->
                <div>
                    <label class="block text-[#8f8f8f] text-sm mb-2">M√°ximo de Turnos por D√≠a</label>
                    <input 
                        type="number" 
                        id="max-turnos"
                        min="1"
                        max="100"
                        class="w-full outline-none p-3 bg-[#1a1a1a] border border-[#3d3d3d] text-white focus:border-white transition"
                    />
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 4: Botones de Acci√≥n -->
        <div class="w-[50%] flex flex-col sm:flex-row gap-4
        max-md:w-full">
            <button 
                id="guardar-configuracion" 
                class="flex-1 bg-white text-black px-6 py-3 hover:bg-gray-200 transition-colors duration-200 cursor-pointer"
            >
                Guardar Configuraci√≥n
            </button>
            <button 
                id="resetear-configuracion" 
                class="hidden flex-1 text-white px-6 py-3 transition-colors duration-200 cursor-pointer"
            >
                Restablecer Valores
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    // D√≠as de la semana (0 = domingo, 6 = s√°bado)
    const DIAS = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

    document.addEventListener('DOMContentLoaded', () => {
        // Verificar autenticaci√≥n antes de cargar
        if (!verificarAutenticacion()) {
            return;
        }
        
        // Cargar configuraci√≥n al iniciar
        cargarConfiguracion();
        
        // Listeners de botones
        document.getElementById('guardar-configuracion').addEventListener('click', guardarConfiguracion);
        document.getElementById('resetear-configuracion').addEventListener('click', resetearConfiguracion);
    });

    // Obtener token de forma segura
    function obtenerToken() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            throw new Error('No hay token de autenticaci√≥n');
        }
        return token;
    }

    // Verificar autenticaci√≥n
    function verificarAutenticacion() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            mostrarMensaje('üîê No hay sesi√≥n activa. Por favor, inicia sesi√≥n.', 'error');
            // Redirigir al login despu√©s de 2 segundos
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return false;
        }
        return true;
    }

    // Cargar configuraci√≥n desde la API
    async function cargarConfiguracion() {
        try {
            const token = obtenerToken();
            console.log('üîë Token encontrado');
            
            const response = await fetch('http://localhost:5000/api/business/config', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            console.log('üì° Status de respuesta:', response.status);

            if (response.status === 401) {
                console.log('‚ùå Error 401 - No autorizado');
                manejarErrorAutenticacion();
                return;
            }

            if (!response.ok) {
                console.log('‚ùå Response not OK:', response.status, response.statusText);
                throw new Error(`HTTP ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            console.log('üì¶ Datos recibidos:', data);
            
            if (data.success) {
                llenarDatosConfiguracion(data);
                mostrarMensaje('‚úì Configuraci√≥n cargada correctamente', 'success');
            } else {
                console.log('‚ùå Success false en respuesta:', data);
                throw new Error(data.mensaje || 'Error en la respuesta del servidor');
            }
        } catch (error) {
            console.error('üí• Error completo:', error);
            if (error.message.includes('token')) {
                manejarErrorAutenticacion();
            } else {
                mostrarMensaje(`‚úó Error: ${error.message}`, 'error');
                // Renderizar d√≠as con valores por defecto como fallback
                renderizarDias();
            }
        }
    }

    // Manejar error de autenticaci√≥n
    function manejarErrorAutenticacion() {
        mostrarMensaje('üîê Sesi√≥n expirada. Redirigiendo al login...', 'error');
        localStorage.removeItem('jwtToken');
        localStorage.removeItem('userData');
        setTimeout(() => {
            window.location.href = '/login';
        }, 2000);
    }

    // Llenar datos de configuraci√≥n en el formulario
    function llenarDatosConfiguracion(data) {
        // Llenar campos de informaci√≥n general
        document.getElementById('nombre-negocio').value = data.configuracion.nombre || '';
        document.getElementById('telefono-negocio').value = data.configuracion.telefono || '';
        document.getElementById('email-negocio').value = data.configuracion.email || '';
        document.getElementById('direccion-negocio').value = data.configuracion.direccion || '';
        
        // Llenar configuraci√≥n adicional
        document.getElementById('duracion-turno').value = data.configuracion.duracion_turno || '60';
        document.getElementById('intervalo-turnos').value = data.configuracion.intervalo_turnos || '30';
        document.getElementById('max-turnos').value = data.configuracion.max_turnos || '20';
        
        // Renderizar d√≠as con los datos cargados
        renderizarDias(data.horarios);
    }

    // Renderizar tarjetas de d√≠as con datos de la BD
    function renderizarDias(horariosBD = []) {
        const container = document.getElementById('diasContainer');
        container.innerHTML = '';

        DIAS.forEach((dia, index) => {
            // Buscar horario para este d√≠a en los datos de la BD
            const horarioDia = horariosBD.find(h => h.dia_semana === index);
            
            const card = document.createElement('div');
            card.className = 'bg-[#1a1a1a] border border-[#3d3d3d] p-4';
            card.innerHTML = `
                <div class="flex items-center gap-2 mb-3">
                    <input 
                        type="checkbox" 
                        class="toggle-dia w-4 h-4 cursor-pointer" 
                        data-dia="${index}"
                        ${horarioDia ? (horarioDia.abierto ? 'checked' : '') : 'checked'}
                    />
                    <h6 class="text-sm font-semibold flex-1">${dia}</h6>
                </div>

                <div class="space-y-2 dia-inputs" data-dia="${index}" 
                     style="opacity: ${horarioDia ? (horarioDia.abierto ? '1' : '0.5') : '1'}; 
                            pointer-events: ${horarioDia ? (horarioDia.abierto ? 'auto' : 'none') : 'auto'}">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-[#8f8f8f]">Apertura</label>
                            <input 
                                type="time" 
                                class="w-full bg-[#101010] border border-[#3d3d3d] p-2 text-white text-sm"
                                data-tipo="apertura"
                                value="${horarioDia && horarioDia.hora_apertura ? horarioDia.hora_apertura.substring(0,5) : '09:00'}"
                            />
                        </div>
                        <div>
                            <label class="text-xs text-[#8f8f8f]">Cierre</label>
                            <input 
                                type="time" 
                                class="w-full bg-[#101010] border border-[#3d3d3d] p-2 text-white text-sm"
                                data-tipo="cierre"
                                value="${horarioDia && horarioDia.hora_cierre ? horarioDia.hora_cierre.substring(0,5) : '18:00'}"
                            />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-[#8f8f8f]">Descanso Inicio</label>
                            <input 
                                type="time" 
                                class="w-full bg-[#101010] border border-[#3d3d3d] p-2 text-white text-sm"
                                data-tipo="descanso-inicio"
                                value="${horarioDia && horarioDia.hora_descanso_inicio ? horarioDia.hora_descanso_inicio.substring(0,5) : '13:00'}"
                            />
                        </div>
                        <div>
                            <label class="text-xs text-[#8f8f8f]">Descanso Fin</label>
                            <input 
                                type="time" 
                                class="w-full bg-[#101010] border border-[#3d3d3d] p-2 text-white text-sm"
                                data-tipo="descanso-fin"
                                value="${horarioDia && horarioDia.hora_descanso_fin ? horarioDia.hora_descanso_fin.substring(0,5) : '14:00'}"
                            />
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(card);
        });

        // Listeners para toggles de d√≠as
        document.querySelectorAll('.toggle-dia').forEach(toggle => {
            toggle.addEventListener('change', (e) => {
                const dia = e.target.dataset.dia;
                const inputs = document.querySelector(`.dia-inputs[data-dia="${dia}"]`);
                inputs.style.opacity = e.target.checked ? '1' : '0.5';
                inputs.style.pointerEvents = e.target.checked ? 'auto' : 'none';
            });
        });
    }

    // Guardar configuraci√≥n
    async function guardarConfiguracion() {
        try {
            const token = obtenerToken();

            // Recopilar datos
            const datos = {
                nombre: document.getElementById('nombre-negocio').value,
                telefono: document.getElementById('telefono-negocio').value,
                email: document.getElementById('email-negocio').value,
                direccion: document.getElementById('direccion-negocio').value,
                duracion_turno: parseInt(document.getElementById('duracion-turno').value),
                intervalo_turnos: parseInt(document.getElementById('intervalo-turnos').value),
                max_turnos: parseInt(document.getElementById('max-turnos').value),
                horarios: recopilarHorarios(),
            };

            console.log('üì§ Enviando datos:', datos);

            // Validaciones b√°sicas
            if (!datos.nombre.trim()) {
                mostrarMensaje('El nombre del negocio es requerido', 'error');
                return;
            }

            const response = await fetch('http://localhost:5000/api/business/config', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos),
            });

            console.log('üì° Respuesta del servidor:', response.status);

            if (response.status === 401) {
                manejarErrorAutenticacion();
                return;
            }

            const result = await response.json();
            console.log('üì¶ Resultado:', result);

            if (!response.ok) {
                throw new Error(result.mensaje || 'Error al guardar');
            }

            mostrarMensaje('‚úì Configuraci√≥n guardada correctamente', 'success');
            
            // Recargar los datos actualizados despu√©s de guardar
            setTimeout(() => {
                cargarConfiguracion();
            }, 1000);
            
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje(`‚úó ${error.message}`, 'error');
        }
    }

    // Recopilar horarios
    function recopilarHorarios() {
        const horarios = [];
        DIAS.forEach((_, index) => {
            const toggle = document.querySelector(`input[type="checkbox"][data-dia="${index}"]`);
            const apertura = document.querySelector(`.dia-inputs[data-dia="${index}"] input[data-tipo="apertura"]`);
            const cierre = document.querySelector(`.dia-inputs[data-dia="${index}"] input[data-tipo="cierre"]`);
            const descansoInicio = document.querySelector(`.dia-inputs[data-dia="${index}"] input[data-tipo="descanso-inicio"]`);
            const descansoFin = document.querySelector(`.dia-inputs[data-dia="${index}"] input[data-tipo="descanso-fin"]`);

            horarios.push({
                dia_semana: index,
                abierto: toggle.checked,
                hora_apertura: apertura.value + ':00', // Formato HH:MM:SS
                hora_cierre: cierre.value + ':00',
                hora_descanso_inicio: descansoInicio.value ? descansoInicio.value + ':00' : null,
                hora_descanso_fin: descansoFin.value ? descansoFin.value + ':00' : null,
            });
        });
        return horarios;
    }

    // Restaurar valores por defecto
    function resetearConfiguracion() {
        if (confirm('¬øEst√°s seguro de que deseas restaurar los valores por defecto? Se perder√°n los cambios no guardados.')) {
            // Limpiar campos
            document.getElementById('nombre-negocio').value = '';
            document.getElementById('telefono-negocio').value = '';
            document.getElementById('email-negocio').value = '';
            document.getElementById('direccion-negocio').value = '';
            document.getElementById('duracion-turno').value = '60';
            document.getElementById('intervalo-turnos').value = '30';
            document.getElementById('max-turnos').value = '20';
            
            // Renderizar d√≠as con valores por defecto
            renderizarDias();
            
            mostrarMensaje('‚Üª Valores restaurados', 'success');
        }
    }

    // Mostrar mensajes
    function mostrarMensaje(texto, tipo) {
        const div = document.getElementById('messageDiv');
        div.textContent = texto;
        div.className = `mb-4 p-4 rounded text-sm ${
            tipo === 'error' ? 'bg-red-900 text-red-200' :
            tipo === 'success' ? 'bg-green-900 text-green-200' :
            'bg-blue-900 text-blue-200'
        }`;
        div.classList.remove('hidden');

        setTimeout(() => {
            div.classList.add('hidden');
        }, 4000);
    }
</script>